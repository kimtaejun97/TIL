> â˜ï¸ ìŠ¤í”„ë§ê³¼ JPA ê¸°ë°˜ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œ - ë°±ê¸°ì„ ë‹˜.


- ë¼ì´ë¸ŒëŸ¬ë¦¬
> - Lombok
> - Spring Boot Devtools
> - Spring Configuration processor : Custom properties ìë™ì™„ì„± ì§€ì›
> - Thymeleaf
> - Spring Security
> - Srping Data JPA
> - PostgreSQL, H2
> - Java mail sender (Spring mail)
> - QueryDSL
> - Spring Validation



## ğŸ“ƒ ëª©ì°¨
***
- #### [íšŒì›ê°€ì… ë·°](#-íšŒì›ê°€ì…-ë·°)
- #### [íŒ¨ìŠ¤ì›Œë“œ ì¸ì½”ë”©](#-íŒ¨ìŠ¤ì›Œë“œ-ì¸ì½”ë”©)
- #### [ì¸ì¦ ë©”ì¼ í™•ì¸](#-ì¸ì¦-ë©”ì¼-í™•ì¸)
- #### [íšŒì›ê°€ì…, ì¸ì¦ í›„ ìë™ ë¡œê·¸ì¸](#-íšŒì›ê°€ì…,-ì¸ì¦-í›„-ìë™-ë¡œê·¸ì¸)
- #### [ì¸ì¦ ìƒíƒœì— ë”°ë¥¸ View](#-ì¸ì¦-ìƒíƒœì—-ë”°ë¥¸-view)
- #### [í”„ë¡ íŠ¸ì—”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •](#-í”„ë¡ íŠ¸ì—”ë“œ-ë¼ì´ë¸ŒëŸ¬ë¦¬-ì„¤ì •)
- #### [í”„ë¡œí•„ ì´ë¯¸ì§€ ë° ì•„ì´ì½˜](#-í”„ë¡œí•„-ì´ë¯¸ì§€-ë°-ì•„ì´ì½˜)
- #### [ì´ë©”ì¼ ì¸ì¦ ê²½ê³ ì°½](#-ì´ë©”ì¼-ì¸ì¦-ê²½ê³ ì°½)
- #### [ì¸ì¦ ì´ë©”ì¼ ì¬ì „ì†¡](#-ì¸ì¦-ì´ë©”ì¼-ì¬ì „ì†¡)
- #### [ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ](#-ë¡œê·¸ì¸--ë¡œê·¸ì•„ì›ƒ)
- #### [ë¡œê·¸ì¸ ê¸°ì–µí•˜](#-ë¡œê·¸ì¸-ê¸°ì–µí•˜ê¸°)
- #### [Profile View](#-profileview)
- #### [RedirectAttribute : FlashAttribute](#-redirectattribute---flashattribute)
- #### [@WithSecurityContext](#--withsecuritycontext)
- #### [í”„ë¡œí•„ ì´ë¯¸ì§€](#-í”„ë¡œí•„-ì´ë¯¸ì§€)
- #### [íŒ¨ìŠ¤ì›Œë“œ ë¹„êµ](#-íŒ¨ìŠ¤ì›Œë“œ-ë³€ê²½)
- #### [ì²´í¬ë°•ìŠ¤ ê°’ ì „ë‹¬](#-ì²´í¬ë°•ìŠ¤-ê°’-ì „ë‹¬)
- #### [Model Mapper](#-model-mapper)
- #### [ajax ì „ì†¡ csrf](#-ajax-ì „ì†¡-csrf)
- #### [ManyToMany](#-manytomany)
- #### [ObjectMapper](#-objectmapper)
- #### [postgresql ì…‹íŒ…](#-postgresql-ì…‹íŒ…)
- #### [sql debug ì„¤ì •](#-sql-debug)
- #### [SMTP ì„¤ì •](#-smtp-ì„¤ì •)
- #### [ì´ë©”ì¼ë¡œ HTML ì „ì†¡](#-ì´ë©”ì¼ë¡œ-html-ì „ì†¡)
- #### [textareaì— ì—ë””í„° ì¶”ê°€í•˜ê¸° : summernote](#-textareaì—-ì—ë””í„°-ì¶”ê°€í•˜ê¸°)
- #### [th:classappend](#-th-classappend)
- #### [BootStrap:ToolTip](#-tooltip)
- #### [EntityGraph](#-entitygraph)
- #### [ì˜ëª»ëœ ì ‘ê·¼ ë°©ì§€](#-ì˜ëª»ëœ-ì ‘ê·¼-ë°©ì§€)
- #### [BootStrap : Modal](#-bootstrap---modal)
- #### [ë‚ ì§œ í˜•ì‹ ë¼ì´ë¸ŒëŸ¬ë¦¬ : Moment.Js](#-ë‚ ì§œ-í˜•ì‹-ë¼ì´ë¸ŒëŸ¬ë¦¬---moment-js)
- #### [íƒ€ì„ë¦¬í”„ : ê°ì²´ì˜ íƒ€ì… ë³€í™˜](#-íƒ€ì„ë¦¬í”„---ê°ì²´ì˜-íƒ€ì…-ë³€í™˜)
- #### [N+1 ì¿¼ë¦¬ ë¬¸ì œ](#-n-1-ì¿¼ë¦¬-ë¬¸ì œ)
- #### [Form Delete Method](#-form-delete-method)
- #### [@PathVariable Repository ì¡°íšŒ](#--pathvariable-repository-ì¡°íšŒ)
- #### [íŒ¨í‚¤ì§€ êµ¬ì¡° ì •ë¦¬](#-íŒ¨í‚¤ì§€-êµ¬ì¡°-ì •ë¦¬)
- #### [test DB ì„¤ì • : TestContainers](#-test-db-ì„¤ì •---testcontainers)
- #### [ë¹„ë™ê¸° EventListener](#-ë¹„ë™ê¸°-eventlistener)
- #### [QeuryDSL](#-qeurydsl)
- #### [Handler Interceptor](#-handler-interceptor)
- #### [í˜ì´ì§•](#-í˜ì´ì§•)
- #### [Mark.js](#-markjs)
- #### [Exception Handler](#-exception-handler)
- #### [ë°°í¬ì‹œ ê³ ë ¤í•  ì ](#-ë°°í¬ì‹œ-ê³ ë ¤í• -ì )











# ğŸ“Œ íšŒì›ê°€ì… ë·°
***
    - íƒ€ì„ë¦¬í”„ : ê°ì²´ë¥¼ í¼ ê°ì²´ë¡œ ì„¤ì •í•˜ê¸°

```html
th:object="${signUpForm}"

th:field="*{nickName}"
th:field="*{email}"
th:field="*{password}"
```        

```java
model.addAttribute(new SignUpForm());
```
- #### attribute nameì„ ìƒëµí•˜ë©´ ê°ì²´ì˜ ì¹´ë©œ ì¼€ì´ìŠ¤ë¡œ ì´ë¦„ì´ ì§€ì •ëœë‹¤. ex)signUpForm
- #### Listì™€ ê°™ì€ Collectionì—ì„œ nameì„ ì§€ì •í•˜ì§€ ì•Šì„ê²½ìš° sizeê°€ 0ì¼ ë•Œ nullë¡œ ë„˜ì–´ê°€ë¯€ë¡œ ì£¼ì˜.


- ## ì œì•½ ê²€ì¦ ê¸°ëŠ¥.
```html
<form class="needs-validation col-sm-6"
      
required minlength="3" maxlength="20"
input type email, password

<small class="invalid-feedback">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.</small>
<small class="form-text text-danger" th:if="${#fields.hasErrors('nickName')}" th:errors="*{nickName}">Nickname Error</small>
```

```javascript
<script type="application/javascript" th:fragment="form-validation">
    (function () {
        'use strict';

        window.addEventListener('load', function () {
            var forms = document.getElementsByClassName('needs-validation');

            Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        .preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated')
                }, false)
            })
        }, false)
    }())
</script>
```
> form.checkValidity ì—ì„œ htmlì—ì„œ ì„ ì–¸í•œ ê²€ì¦ ì²´í¬. ìœ íš¨í•˜ì§€ ì•Šì„ ê²½ìš° class ="invalid-feedback"ì— í•´ë‹¹í•˜ëŠ” ê°’ ì¶œë ¥.
> th:errors ì—ëŠ” ì„œë²„ì—ì„œ ê²€ì¦í•œ í•´ë‹¹ í•„ë“œì— ëŒ€í•œ ì—ëŸ¬ê°€ ë‹´ê¹€.

# ğŸ“Œ í¼ ì„œë¸Œë°‹ ê²€ì¦
***
### -  íšŒì› ê°€ì… í¼ ê²€ì¦.
> - #### JSR 303 ì—ë…¸í…Œì´ì…˜ ê²€ì¦
>    - ê°’ ê¸¸ì´, í•„ìˆ˜ ê°’
>  > @NotBlank    
    @Length(min=3, max=20)    
    @Pattern(regexp = "([ã„±-ã…ê°€-í£-a-z0-9_-]{3,20}$)")    
    @Email
> - #### ì»¤ìŠ¤í…€ ê²€ì¦
>    - ì¤‘ë³µ ì´ë©”ì¼, ë‹‰ë„¤ì„ ì—¬ë¶€ í™•ì¸.
> > implements Validator
> - #### í¼ ì—ëŸ¬ ë°œìƒ ì‹œ í¼ ë‹¤ì‹œ ë³´ì—¬ì£¼ê¸°.
> ```java
> @PostMapping("/sign-up")
> public String signUpSubmit(@Valid SignUpForm signUpForm, Errors errors){
>   if(errors.hasErrors()){
>       return "account/sign-up";
> }
>   return "redirect:/";
> }
> ```
> - Errors ëŠ” ë°˜ë“œì‹œ @Valid ê°ì²´ ë‹¤ìŒìœ¼ë¡œ ì™€ì•¼í•¨.
> - ì—ëŸ¬ê°€ ìˆì„ ë•Œ form ê°ì²´ë¥¼ ìë™ìœ¼ë¡œ modelì— ì¶”ê°€í•˜ì—¬ ëŒë ¤ì¤Œ. (ì…ë ¥ê°’ í¬í•¨)
>

- ì»¤ìŠ¤í…€ ê²€ì¦
```java
@Override
public boolean supports(Class<?> aClass) {
    return aClass.isAssignableFrom(SignUpForm.class);
}

@Override
public void validate(Object o, Errors errors) {
    //TODO email, nickname ì¤‘ë³µ ì—¬ë¶€.
    SignUpForm signUpForm = (SignUpForm) errors;
    if(accountRepository.existsByEmail(signUpForm.getEmail())){
        errors.rejectValue("email","invalid.email", new Object[]{signUpForm.getEmail()}, "ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì´ë©”ì¼ ì…ë‹ˆë‹¤.");
    }
    if(accountRepository.existsNickName(signUpForm.getNickName())){
        errors.rejectValue("nickName","invalid.nickName", new Object[]{signUpForm.getNickName()}, "ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ë‹‰ë„¤ ì…ë‹ˆë‹¤.");
    }

}
```

1. @InitBinderë¥¼ ì´ìš©í•œ Validator ë“±ë¡.
```java
//ê°ì²´ì˜ ì¹´ë©œì¼€ì´ìŠ¤.
@InitBinder("signUpForm")
public void initBinder(WebDataBinder webDataBinder){
    webDataBinder.addValidators(signUpFormValidator);
}
```

2. ë©”ì„œë“œì— errorsì™€ ê²€ì¦ ê°ì²´ë¥¼ ë„˜ê²¨ error ë°›ì•„ì˜¤ê¸°
```java
sighUpFormValidator.validate(signUpForm, errors);
if(errors.hasError()){
    ...
}
```
- validate ë¿ë§Œ ì•„ë‹ˆë¼ ìƒˆë¡œìš´ ë©”ì„œë“œë¥¼ ìƒì„±í•˜ì—¬ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ê²€ì¦ ê°€ëŠ¥.

# ğŸ“Œ íšŒì› ê°€ì… ì²˜ë¦¬
****
### 1. íšŒì› ì •ë³´ ì €ì¥.
```java
private Account saveNewAccount(SignUpForm signUpForm) {
        Account account = Account.builder()
                .email((signUpForm.getEmail()))
                .nickName(signUpForm.getNickName())
                .password(passwordEncoder.encode(signUpForm.getPassword()))
                .studyCreatedByWeb(true)
                .studyEnrollmentResultByWeb(true)
                .studyUpdatedByWeb(true)
                .build();

        Account newAccount = accountRepository.save(account);
        return newAccount;
    }
```
### 2. ì¸ì¦ ì´ë©”ì¼ ë°œì†¡.
```java
newAccount.generateEmailCheckToken();

private void sendSignUpConfirmEmail(Account newAccount) {
        SimpleMailMessage mailMessage = new SimpleMailMessage();
        mailMessage.setTo(newAccount.getEmail());
        mailMessage.setSubject("íšŒì› ê°€ì… ì¸ì¦");
        //check-email-token ì—ì„œ tokenì´ ìœ íš¨í•œì§€ í™•ì¸.
        mailMessage.setText("/check-email-token?token="+ newAccount.getEmailCheckToken()
                + "&email=" + newAccount.getEmail());

        javaMailSender.send(mailMessage);
    }
```
### 3. ì™„ë£Œ í›„ ì›°ì»´ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸.


### - í…ŒìŠ¤íŠ¸
- CSRF Token : íƒ€ ì‚¬ì´íŠ¸ì—ì„œ í¼ ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ê²ƒì„ ë°©ì§€.
- ì…ë ¥ê°’ì´ ì •ìƒ ì¼ ê²½ìš°, ì˜ëª» ëœ ì…ë ¥ ê°’ì¼ ê²½ìš° í…ŒìŠ¤íŠ¸.

```java
@MockBean
JavaMailSender javaMailSender;

@DisplayName("íšŒì› ê°€ì… ì²˜ë¦¬ - ì…ë ¥ê°’ ì •ìƒ")
    @Test
    void signUpSubmit_with_correct_input() throws Exception {
        mockMvc.perform(post("/sign-up")
                .param("nickName","bigave")
                .param("email", "correct@email.com")
                .param("password","12345678")
                .with(csrf()))  //csrf tokenì„ ë„£ì–´ì¤Œ.
                .andExpect(status().is3xxRedirection())
                .andExpect(view().name("redirect:/"));

        Account account =accountRepository.findByEmail("correct@email.com");
        assertNotNull(account);
        assertNotNull(account.getEmailCheckToken());
        
        //send ë©”ì„œë“œê°€ í˜¸ì¶œ ë˜ì—ˆëŠ”ì§€. org.mockito
        then(javaMailSender).should().send(any(SimpleMailMessage.class));
    }
```

# ğŸ“Œ íŒ¨ìŠ¤ì›Œë“œ ì¸ì½”ë”©
****
> - ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ ê¶Œì¥í•˜ëŠ” PasswordEncoderëŠ” bycrypt í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©.
> - ì†”íŠ¸(salt) : í•´ì»¤ê°€ ì´ë¯¸ ì—¬ëŸ¬ê°œì˜ í•´ì‹± ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ì €ì¥í•´ë†“ê³ , í•´ì‹œê°’ì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¶”ë¡ í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ê³ ì•ˆ. 
> > hash(12345678) -> aaaabbbb    
> > hash(12344567+salt)-> aacabaebb    
> > hash(12344567+salt)-> cafcabaekkb
> > ë§¤ë²ˆ ë‹¤ë¥¸ ê°’ì´ ë‚˜ì˜´.
```java
@Bean
public PasswordEncoder passwordEncoder(){
    return PasswordEncoderFactories.createDelegatingPasswordEncoder();
}
```
- Test
```java
Account account =accountRepository.findByEmail("correct@email.com");

assertNotEquals(account.getPassword(), "12345678");
```


# ğŸ“Œ ì¸ì¦ ë©”ì¼ í™•ì¸
*****
```java
@GetMapping("/check-email-token")
public String checkEmailToken(String token, String email, Model model){
    Account account = accountRepository.findByEmail(email);
    String view = "account/checked-email";

    if(account == null){
        model.addAttribute("error", "wrong.email");
        return view;
    }

    if (!account.getEmailCheckToken().equals(token)){
        model.addAttribute("error", "wrong.token");
        return view;
    }

    account.setEmailVerified(true);
    account.setJoinedAt(LocalDateTime.now());
    model.addAttribute("numberOfUser", accountRepository.count());

    return view;
}
```
> - ì¸ì¦ ë©”ì¼ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šë‹¤ë©´ errorë¥¼ ë‹´ê³ , ì˜¬ë°”ë¥´ë©´ ì´ë©”ì¼ ì¸ì¦í‘œì‹œë¥¼ í•˜ê³  ê°€ì… ë‚ ì§œë¥¼ ê³„ì •ì •ë³´ì— ì¶”ê°€.
> - checked-email í˜ì´ì§€ì—ì„œ errorì˜ ì—¬ë¶€ì— ë”°ë¼ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤€ë‹¤.


# ğŸ“Œ íšŒì› ê°€ì…, ì¸ì¦ í›„ ìë™ ë¡œê·¸ì¸
****
> - ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ ë¡œê·¸ì¸ : SecurityContextì— Authentication(token)ì´ ì¡´ì¬ í•˜ëŠ”ê°€.
> - UsernamePasswordAuthenticationToken ìœ¼ë¡œ tokenì„ ìƒì„±í•˜ê³  SecuriryContextì— ë„£ì–´ì¤€ë‹¤.
```java
public void login(Account account) {

    UsernamePasswordAuthenticationToken token = new UsernamePasswordAuthenticationToken(
            account.getNickName(),
            account.getPassword(),
            List.of(new SimpleGrantedAuthority("ROLE_USER"))
    );

    SecurityContext context = SecurityContextHolder.getContext();
    context.setAuthentication(token);
}
```

# ğŸ“Œ ì¸ì¦ ìƒíƒœì— ë”°ë¥¸ View
***
```html
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity5</artifactId>
</dependency>


<html xmlns:sec="http://www.thymeleaf.org/extras/spring-security"></html>

<li class="nav-item" sec:authorize="!isAuthenticated()">
    <a class="nav-link" href="#" th:href="@{/login}">ë¡œê·¸ì¸</a>
</li>
```
- isAuthenticated()ë¥¼ ì´ìš©í•˜ì—¬ ì¸ì¦ ìƒíƒœì¸ì§€ ì—¬ë¶€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.
```html
${#authentication.name} ë¡œ ì´ë¦„ ì°¸ì¡°ë„ ê°€ëŠ¥.
```


# ğŸ“Œ í”„ë¡ íŠ¸ì—”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •
***
> - Web Jar , NPM
> - WebJarëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—…ë°ì´íŠ¸ê°€ ëŠë¦¬ê³ , ì˜¬ë¼ì˜¤ì§€ ì•Šì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë„ í”í•˜ë‹¤.

- ### ìŠ¤í”„ë§ ë¶€íŠ¸ì™€ NPM
> - src/main/resource/static ì´í•˜ì—ì„œëŠ” ì •ì  ë¦¬ì†ŒìŠ¤ë¡œ ì œê³µ(ìŠ¤í”„ë§ ë¶€íŠ¸)
> - package.jsonì— í”„ë¡ íŠ¸ì—”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì œê³µ
> - static ë””ë ‰í† ë¦¬ ì•„ë˜ì— package.jsonì„ ìœ„ì¹˜. -> ì •ì  ë¦¬ì†ŒìŠ¤ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©.
> > static ë””ë ‰í† ë¦¬ë¡œ ì´ë™.    
> > npm init   
> > npm install bootstrap   
> > npm install jquery
> - .ginignoreì— node_modules, node ì¶”ê°€.

```html
<link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.css">

<script src="/node_modules/jquery/dist/jquery.js"></script>
<script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.js"></script>
```
- ### ë¹Œë“œ
> - pom.xmlì„ ë¹Œë“œí•  ë•Œ static ì•„ë˜ package.jsonë„ ë¹Œë“œí•˜ë„ë¡ ì„¤ì •.
> 

```xml
<plugin>
    <groupId>com.github.eirslett</groupId>
    <artifactId>frontend-maven-plugin</artifactId>
    <version>1.8.0</version>
    <configuration>
        <nodeVersion>v4.6.0</nodeVersion>
        <workingDirectory>src/main/resources/static</workingDirectory>
    </configuration>
    <executions>
        <execution>
            <id>install node and npm</id>
            <goals>
                <goal>install-node-and-npm</goal>
            </goals>
            <phase>generate-resources</phase>
        </execution>
        <execution>
            <id>npm install</id>
            <goals>
                <goal>npm</goal>
            </goals>
            <phase>generate-resources</phase>
            <configuration>
                <arguments>install</arguments>
            </configuration>
        </execution>
    </executions>
</plugin>
```


- ### ì‹œíë¦¬í‹° ì„¤ì •
```java
 @Override
    public void configure(WebSecurity web) throws Exception {
        web.ignoring()
                .mvcMatchers("/node_modules/**")
                .requestMatchers(PathRequest.toStaticResources().atCommonLocations());

    }
```
- CommonLocationì—ì„œëŠ” node_modulesë¥¼ í¬í•¨í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë”°ë¡œ ì¶”ê°€í•´ ì£¼ì–´ì•¼ í•œë‹¤.


# ğŸ“Œ í”„ë¡œí•„ ì´ë¯¸ì§€ ë° ì•„ì´ì½˜
*****
> - npm install jdenticon
> - npm install font-awesome


```html
<link rel="stylesheet" href="/node_modules/font-awesome/css/font-awesome.css">
<script src="/node_modules/jdenticon/dist/jdenticon.js"></script>

<i class="fa fa-bell-o"> </i>
<svg data-jdenticon-value="user127" th:data-jdenticon-value="${#authentication.name}" width="24" height="24" class="rounded border bg-light"></svg>

```
- font-awesome : fa {docs ì°¸ì¡°í•´ì„œ ì•„ì´ì½˜ id}
- jdenticon : nameì— ë”°ë¼ ë‹¤ë¥¸ ê°’ì´ ë“¤ì–´ê°€ë„ë¡ ì„¤ì • í•¨.


# ğŸ“Œ ì´ë©”ì¼ ì¸ì¦ ê²½ê³ ì°½.
****
```html
<div class ="alert alert-warning" role="alert" th:if="${account != null && !account.emailVerified}" >
    ê°€ì…ì„ ì™„ë£Œí•˜ë ¤ë©´ <a href="#" th:href="@{/check-email}" class="alert-link">ê³„ì • ì¸ì¦ ì´ë©”ì¼ì„ í™•ì¸ í•˜ì„¸ìš”.</a>
</div>
```

```java
@GetMapping("/")
public String home(@CurrentUser Account account, Model model){
    if(account != null){
        model.addAttribute(account);
    }

    return "index";
```

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.PARAMETER)
@AuthenticationPrincipal(expression = "#this =='anonymousUser' ? null :account")
public @interface CurrentUser {

}
```
- Userì¸ì¦ì´ ë˜ì§€ ì•Šìœ¼ë©´ Principal ì€ "anonymousUser"ë¼ëŠ” ë¬¸ìì—´. ì¸ì¦ì´ ë˜ì–´ìˆì§€ ì•Šë‹¤ë©´ nullì„ ì¸ì¦ì´ ë˜ì–´ìˆë‹¤ë©´ principalì—ì„œ account ê°ì²´ë¥¼ êº¼ë‚´ ë„˜ê²¨ì¤€ë‹¤.

```java
UsernamePasswordAuthenticationToken token = new UsernamePasswordAuthenticationToken(
                new UserAccount(account),
                account.getPassword(),
                List.of(new SimpleGrantedAuthority("ROLE_USER"))
        );
```
- loginì—ì„œ AuthenticationPrincipalì„ ë‹‰ë„¤ì„ì´ ì•„ë‹Œ UserAccountë¡œ ë³€ê²½.

```java
@Getter
public class UserAccount extends User {

    private Account account;

    public UserAccount(Account account) {
        super(account.getNickName(), account.getPassword(), List.of(new SimpleGrantedAuthority("ROLE_USER")));
        this.account =account;
    }
}
```
- account ë¼ëŠ” í•„ë“œëª…ì€ @CurrentUser Account account ì˜ account ì™€ ë§¤í•‘ëœë‹¤.


# ğŸ“Œ ì¸ì¦ ì´ë©”ì¼ ì¬ì „ì†¡
***
```java
@GetMapping("/resend-confirm-email")
public String resendPage(@CurrentUser Account account, Model model){

    if(!account.canConfirmEmail()){
        model.addAttribute("error", "ì¸ì¦ ì´ë©”ì¼ì€ 10ë¶„ì— í•œë²ˆë§Œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        model.addAttribute("email",account.getEmail());
        return "account/check-email";
    }

    accountService.resendConfirmEmail(account.getNickName());
    return "redirect:/";
}
```

```java
@Transactional
public void resendConfirmEmail(String nickName) {
        Account account = accountRepository.findByNickName(nickName);
        account.generateEmailCheckToken();

        SimpleMailMessage simpleMailMessage = new SimpleMailMessage();
        simpleMailMessage.setTo(account.getEmail());
        simpleMailMessage.setSubject("ìŠ¤í„°ë””ì›¹ íšŒì› ì¸ì¦");
        simpleMailMessage.setText("/check-email-token?token="+account.getEmailCheckToken()
        +"&email="+account.getEmail());

        javaMailSender.send(simpleMailMessage);
}
```
- canConfirmEmail()ì—ì„œëŠ” í˜„ì¬ ì‹œê°„ê³¼ ë§ˆì§€ë§‰ìœ¼ë¡œ checkTokenì„ ìƒì„±í•œ ì‹œê°„ì„ ë¹„êµí•˜ì—¬ 10ì´ ì§€ë‚˜ì§€ ì•Šì•˜ë‹¤ë©´ ì „ì†¡í•˜ì§€ ì•Šê³  ê²½ê³ ì°½.
- í† í°ì„ ìƒˆë¡œ ë§Œë“¤ì–´ ì´ë©”ì¼ ì „ì†¡.


# ğŸ“Œ ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ
***
```java
http.formLogin()
            .loginPage("/login").permitAll()
            .and()
        .logout().logoutSuccessUrl("/");
```

```java
@Override
public UserDetails loadUserByUsername(String emailOrNickName) throws UsernameNotFoundException {
    Account account =  accountRepository.findByEmail(emailOrNickName);
    if(account == null){
        account = accountRepository.findByNickName(emailOrNickName);
    }
    if(account == null){
        throw new UsernameNotFoundException(emailOrNickName);
    }

    return new UserAccount(account);

}
```
- UserDetailsServiceì˜ loadUserByUsernameì„ êµ¬í˜„.
- Userë¥¼ ìƒì†í•œ UserAccounë¥¼ ë°˜í™˜.

```java
private Account account;

    public UserAccount(Account account) extends User{
        super(account.getNickName(), account.getPassword(), List.of(new SimpleGrantedAuthority("ROLE_USER")));
        this.account =account;
    }
```
- ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” formLogin()ì´ ì•„ë‹Œ ìƒˆë¡œ login.htmlì„ ë§Œë“¤ì–´ ë§¤í•‘.
- Spring Securityì˜ Userì„ ìƒì†ë°›ëŠ” í´ë˜ìŠ¤ì¸ UserAccountë¥¼ ì´ìš©í•˜ì—¬ ì¸ì¦.
- return User() ë¡œë„ ê°€ëŠ¥.

# ğŸ“Œ ë¡œê·¸ì¸ ê¸°ì–µí•˜ê¸°
***
- ê¸°ë³¸ì ìœ¼ë¡œ Sessionì˜ íƒ€ì„ ì•„ì›ƒì€ 30ë¶„.
```properties
server.servlet.session.timeout=30m
```
- ì„¸ì…˜ì´ ë§Œë£Œ ë˜ë”ë¼ë„ ë¡œê·¸ì¸ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ë°©ë²•(RememberMe)
    > ì¿ í‚¤ì— ì¸ì¦ ì •ë³´ë¥¼ ë‚¨ê²¨ë‘ê³  ì„¸ì…˜ì´ ë§Œë£Œ ëì„ ë•Œ ì¿ í‚¤ì— ë‚¨ì•„ìˆëŠ” ì •ë³´ë¡œ ì¸ì¦. 
    
- í•´ì‹œ ê¸°ë°˜ì˜ ì¿ í‚¤
> - UserName
> - Password
> - ë§Œë£Œê¸°ê°„
> - Key
> - ì¿ í‚¤ë¥¼ íƒˆì·¨ë‹¹í•˜ë©´ ê·¸ ê³„ì •ì„ íƒˆì·¨ë‹¹í•œ ê²ƒê³¼ ê°™ë‹¤.

- ì¡°ê¸ˆ ë” ì•ˆì „í•˜ê²Œ ê´€ë¦¬í•˜ê¸°
> - ì¿ í‚¤ ì•ˆì— ëœë¤í•œ tokenì„ ë§Œë“¤ì–´ ê°™ì´ ì €ì¥í•˜ê³  ì¸ì¦ ë•Œë§ˆë‹¤ ë³€ê²½.
> - Username, í† í°
> - í•´ë‹¹ ë°©ë²•ë„ ì·¨ì•½, í•´ì»¤ê°€ ì¿ í‚¤ë¡œ ì¸ì¦ì„ í•˜ê²Œë˜ë©´ ì› ì‚¬ìš©ìëŠ” ì¸ì¦í•  ìˆ˜ ì—†ê²Œ ë¨.

- ê°œì„ ëœ ë°©ë²•
> - UserName, Token(ëœë¤, ë§¤ë²ˆ ë³€ê²½), ì‹œë¦¬ì¦ˆ(ëœë¤,ê³ ì •)
> - ì¿ í‚¤ë¥¼ íƒˆì·¨ ë‹¹í•˜ë©´ ì› ì‚¬ìš©ìëŠ” ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ê³¼ ìœ íš¨í•œ ì‹œë¦¬ì¦ˆ,UserName ìœ¼ë¡œ ì ‘ì†í•˜ê²Œ ë˜ê³ , ì´ ê²½ìš°, ëª¨ë“  í† í°ì„ ì‚­ì œí•˜ì—¬ í•´ì»¤ê°€ ë”ì´ìƒ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•˜ë„ë¡ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.


- ### ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì • : í•´ì‹œ ê¸°ë°˜
```java
http.rememberMe().key("ëœë¤ í‚¤ê°’");
```

- ### ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì •: ê°œì„ ëœ ì˜ì†í™” ê¸°ë°˜ ì„¤ì •.

```html
<div class="form-grop form-check">
    <input type="checkbox" class="form-check-input" id="rememberMe", name="remember-me" checked>
    <label class="form-check-label" for="rememberMe" aria-describedby="rememberMeHelp">ë¡œê·¸ì¸ ìœ ì§€</label>
</div>
```
- name ì„ remember-meë¡œ ì£¼ê³  check boxê°€ true ê°’ì´ë©´ remember-me ê¸°ëŠ¥ ì‹¤í–‰.

```java
private final AccountService accountService;
private final DataSource dataSource;

http.rememberMe()
        .userDetailsService(accountService)
        .tokenRepository(tokenRepository());

@Bean
public PersistentTokenRepository tokenRepository(){
        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();
        jdbcTokenRepository.setDataSource(dataSource);
        return jdbcTokenRepository;

        }
```
- userDetailsServiceì™€ TokenRepositoryë¥¼ ë„˜ê²¨ì¤Œ. ì—¬ê¸°ì„œëŠ” UserDetilasServiceë¥¼ êµ¬í˜„í•œ AccountServiceë¥¼ ë„˜ê²¨ ì£¼ì—ˆë‹¤.

```java
@Getter @Setter
@Table(name = "persistent_logins")
@Entity
public class PersistentLogins {

    @Id
    @Column(length = 64)
    private String series;

    @Column(nullable = false, length = 64)
    private String username;

    @Column(nullable = false, length = 64)
    private String token;

    @Column(name = "last_used",nullable = false, length = 64)
    private LocalDateTime lastUsed;
}
```
- JdbcTokenRepositoryImplì—ì„œ ë§Œë“œëŠ” í…Œì´ë¸” ì—”í‹°í‹°ë¥¼ ë§¤í•‘ ì‹œì¼œì¤€ë‹¤.
- JdbcTokenRepositoryImpl class ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

# ğŸ“Œ profileView
****
```java
   @GetMapping("/profile/{nickname}")
    public String viewProfile(@PathVariable String nickname, @CurrentUser Account account, Model model){
        Account byNickName = accountRepository.findByNickName(nickname);

        if(byNickName == null){
            throw new IllegalArgumentException(nickname+"ì— í•´ë‹¹í•˜ëŠ” ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤");
        }

        //account
        model.addAttribute(byNickName);
        model.addAttribute("isOwner", byNickName.equals(account));

        return "account/profile";

    }
```

```html
<div class="row mt-5 justify-content-center">
    <div class="col-2">
        <!-- image -->
        <svg th:if="${#strings.isEmpty(account.profileImage)}" class="img-fluid float-left rounded img-thumbnail"
            th:data-jdenticon-value="${account.nickName}" width="125", height="125"></svg>
        <img th:if="${!#strings.isEmpty(account.profileImage)}" class="img-fluid float-left rounded img-thumbnail"
             th:src="${account.profileImage}" width="125", height="125"/>
    </div>
    <div class="col-8">
        <h1 class="display-4" th:text="${account.nickName}"></h1>
        <p class="lead" th:if="${!#strings.isEmpty(account.bio)}" th:text="${account.bio}"></p>
        <p class="lead" th:if="${#strings.isEmpty(account.bio) && isOwner}" >
            <span>í•œ ì¤„ ì†Œê°œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</span>
        </p>
    </div>
</div>
```


# ğŸ“Œ RedirectAttribute : FlashAttribute
****
```java
 @PostMapping("/settings/profile")
    public  String RedirectMessage(RedirectAttributes attributes){
    
        attributes.addFlashAttribute("message", "RedirectMessage");
        
        return "redirect:/settings/profile";
    }
```
```html
<div th:if="${message}" class ="alert alert-success alert-dismissible fade show mt-3" role="alert">
    <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Success:"><use xlink:href="#check-circle-fill"/></svg>
    <span th:text="${message}">ë©”ì‹œì§€</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </button>
</div>
```
- RedirectAttribute ë¥¼ ì´ìš©í•˜ì—¬ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•  ë•Œ ë°ì´í„°ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆë‹¤.
- FlashAttribute ëŠ” í•œë²ˆ ì‚¬ìš©í•˜ê³  ì‚¬ë¼ì§€ëŠ” ì¼íšŒì„± ë°ì´í„°.
- modelì— ì¶”ê°€ëœ ì–´íŠ¸ë¦¬ë·°íŠ¸ì²˜ëŸ¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.


# ğŸ“Œ @WithSecurityContext
****
```java
@Retention(RetentionPolicy.RUNTIME)
@WithSecurityContext(factory = WithAccountSecurityContextFactory.class )
public @interface WithAccount {
    String value();
}
```
```java
@RequiredArgsConstructor
public class WithAccountSecurityContextFactory implements WithSecurityContextFactory<WithAccount> {

    private final AccountService accountService;

    @Override
    public SecurityContext createSecurityContext(WithAccount withAccount) {

        SignUpForm signUpForm = new SignUpForm();
        signUpForm.setNickName(withAccount.value());
        signUpForm.setEmail("test@email.com");
        signUpForm.setPassword("123123123");
        accountService.processNewAccount(signUpForm);

        UserDetails principal = accountService.loadUserByUsername(withAccount.value());

        Authentication authentication = new UsernamePasswordAuthenticationToken(principal, principal.getPassword(), principal.getAuthorities());
        SecurityContext context = SecurityContextHolder.createEmptyContext();
        context.setAuthentication(authentication);

        return context;
    }
}
```
- í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ë•Œ íŠ¹ì • ì»¨íƒìŠ¤íŠ¸ê°€ ë“±ë¡ë˜ì–´ ìˆì–´ì•¼í•˜ëŠ” í…ŒìŠ¤íŠ¸ì˜ ê²½ìš°(ë¡œê·¸ì¸) Securitycontextë¥¼ ìƒì„±í•˜ì—¬ ë“±ë¡í•œ í›„ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆë‹¤.
> 1. ê³„ì • ìƒì„±
> 2. UserDetails ê°ì²´ ìƒì„±. (springSecurity.core.User)
> 3. ì¸ì¦ í† í° ìƒì„±(principal, password, Authorities)
> 4. Security Contextë¥¼ ìƒì„±í•˜ê³  ì¸ì¦í† í°ì„ ë“±ë¡.




# ğŸ“Œ í”„ë¡œí•„ ì´ë¯¸ì§€
***
```html
<div class="form-group">
    <input id="profileImage" type="hidden" th:field="*{profileImage}" class="form-control" />
</div>
```
```html
 <img th:if="${!#strings.isEmpty(profile.profileImage)}" class="rounded"
      th:src="${profile.profileImage}" width="125" height="125"/>
```
- String íƒ€ì…ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.  HTMLì˜ DataURL ì´ë¯¸ì§€ëŠ” data:imageë¡œ ì‹œì‘
- ``` if (!e.target.result.startsWith("data:image"))``` ì²˜ëŸ¼ ì´ë¯¸ì§€ì¸ì§€ í™•ì¸ ê°€ëŠ¥.
- server.tomcat.max-http-form-post-size=5MB ì™€ê°™ì´ ì„¤ì •í•˜ì—¬ formìœ¼ë¡œ ì „ì†¡ê°€ëŠ¥í•œ ì´ë¯¸ì§€ í¬ê¸° ë³€ê²½ê°€ëŠ¥.

# ğŸ“Œ íŒ¨ìŠ¤ì›Œë“œ ë¹„êµ
****
```java
passwordEncoder.matches(String rawPassword, String encodedPassword)
```

# ğŸ“Œ ì²´í¬ë°•ìŠ¤ ê°’ ì „ë‹¬
****
```java
<div class="custom-control custom-switch custom-control-inline">
        <input type="checkbox" th:field="*{studyCreatedByEmail}" class="custom-control-input" id="studyCreatedByEmail">
        <label class="custom-control-label" for="studyCreatedByEmail">ì´ë©”ì¼ë¡œ ë°›ê¸°</label>
</div>  
```
- ë˜‘ê°™ì´ fieldë¡œ ë°›ê³  boolean ê°’ìœ¼ë¡œ ì €ì¥. ì²´í¬í•˜ë©´ true


# ğŸ“Œ Model Mapper
*****
- ê°ì²´ì˜ í”„ë¡œí¼ë¥¼ ë‹¤ë¥¸ ê°ì²´ì˜ í”„ë¡œí¼í‹°ë¡œ ë§¤í•‘í•´ì£¼ëŠ” ìœ í‹¸ë¦¬í‹° ë¼ì´ë¸ŒëŸ¬
```xml
<dependency>
    <groupId>org.modelmapper</groupId>
    <artifactId>modelmapper</artifactId>
    <version>2.4.4</version>
</dependency>
```

```java

@Bean
public ModelMapper modelMapper(){
    ModelMapper modelMapper = new ModelMapper();
    modelMapper.getConfiguration()
        .setDestinationNameTokenizer(NameTokenizers.UNDERSCORE)
        .setSourceNameTokenizer(NameTokenizers.UNDERSCORE);
    
    return modelMapper
}
```
- NameTokenizers.UNDERSCORE : _ë¥¼ ì‚¬ìš©í–ˆì„ ë•Œì—ë§Œ nested ê°ì²´(account_nickName -> account.nickName)ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼,      ì•„ë‹ˆë¼ë©´ í•´ë‹¹ ê°ì²´ì˜ í”„ë¡œí¼í‹°ë¡œ ê°„ì£¼í•œë‹¤.

```java
//modelMapper.map(source, destination)
        
1. modelMapper.map(profile, account);
2. model.addAttribute(modelMapper.map(account, Notification.class));


```
- source ê°ì²´ì˜ í”„ë¡œí¼í‹° ê°’ë“¤ì„ destination ê°ì²´ì˜ í”„ë¡œí¼í‹° ê°’ì— ë§¤í•‘ì‹œì¼œ ê°’ì„ í• ë‹¹í•œë‹¤.
- 2ë²ˆê³¼ ê°™ì´ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ í• ë‹¹ë„ ê°€ëŠ¥.

# ğŸ“Œ ajax ì „ì†¡ csrf
****
```javascript
<script type="application/javascript" th:inline="javascript">
    var csrfToken = /*[[${_csrf.token}]]*/null;
    var csrfHeader = /*[[${_csrf.headerName}]]*/null;
    $(document).ajaxSend(function (e, xhr, options){
       xhr.setRequestHeader(csrfHeader, csrfToken);
    });
</script>
```
- í—¤ë”ì— csrf í† í° ì¶”ê°€.

# ğŸ“Œ ManyToMany
****
```java
@ManyToMany
private Set<Tag> tags;

public void addTag(Account account, Tag tag) {
    Optional<Account> byId = accountRepository.findById(account.getId());

    byId.ifPresent(a -> a.getTags().add(tag));
}
```
- ìë™ìœ¼ë¡œ account_tags í…Œì´ë¸”ì„ ìƒì„±í•˜ê³  ì¡°ì¸ì´ ë°œìƒ.   
![img.png](img.png)



# ğŸ“Œ ObjectMapper
***
```java
import com.fasterxml.jackson.databind.ObjectMapper;

private ObjectMapper objectMapper;

List<String> allTags = tagRepository.findAll().stream().map(Tag::getTitle).collect(Collectors.toList());
model.addAttribute("whitelist", objectMapper.writeValueAsString(allTags));
```
- String Listë¥¼ String Jsonìœ¼ë¡œ ë³€í™˜
- readTree : String -> JsonNode
- readValue : Json -> Object, Json -> Map
- ë“± ë§ì€ ë©”ì†Œë“œ ì§€ì›.


# ğŸ“Œ postgresql ì…‹íŒ…
***
```
create database {name};
create user {name} with encrypted password 'password';

//ê¶Œí•œ ë¶€
grant all privileges on database {dbname} to {username};
```

# ğŸ“Œ sql debug
****

```properties
spring.jpa.properties.hibernate.format_sql=true
logging.level.org.hibernate.SQL = DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder = TRACE
```


# ğŸ“Œ SMTP ì„¤ì •
****
- êµ¬ê¸€ Gmailì„ SMTP ì„œë²„ë¡œ ì‚¬ìš©í•˜ê¸°.(ì¼ì¼ ì œí•œ)
  > https://support.google.com/mail/answer/185833ì„±    
  > App íŒ¨ìŠ¤ì›Œë“œ ìƒì„±.
```properties
# mail ì„¤ì •
spring.mail.host = smtp.gmail.com
spring.mail.port=587
spring.mail.username =kimtaejun9705@gmail.com
spring.mail.password = ntszbexsramcvvvs
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.timeout=5000
spring.mail.properties.mail.smtp.starttls.enable=true
```
- spring boot ì—ì„œ í•´ë‹¹ ì„¤ì •ë“¤ì„ ê°€ì§€ê³   JavaMailSender Bean ì„ ìë™ìœ¼ë¡œ ë“±ë¡ í•´ì¤€ë‹¤.


### ëŒ€ì²´ ì„œë¹„ìŠ¤
- https//mailchimp.com/
- https://sendgrid.com/
- https://www.mailgun.com/ 
- https://aws.amazon.com/ses/
- https://gsuite.google.com


# ğŸ“Œ ì´ë©”ì¼ë¡œ HTML ì „ì†¡
*****

```java
public class HtmlEmailService implements EmailService{

    private final JavaMailSender javaMailSender;

    @Override
    public void send(EmailMessage emailMessage) {
        MimeMessage mimeMessage = javaMailSender.createMimeMessage();

        try{
            MimeMessageHelper mimeMessageHelper = new MimeMessageHelper(mimeMessage,true,"UTF-8");
            mimeMessageHelper.setTo(emailMessage.getTo());
            mimeMessageHelper.setSubject(emailMessage.getSubject());
            mimeMessageHelper.setText(emailMessage.getText(),true);

            javaMailSender.send(mimeMessage);
            log.info("sent email:{}",emailMessage.getText());

        }catch (MessagingException e){
            log.error("failed to send email : ",e);

        }

    }
}
```
- MimeMessageë¥¼ ìƒì„±í•˜ê³ , ì´ë¥¼ Helperë¡œ ê°ì‹¼ í›„  TO, Subject,Textë¥¼ ì„¤ì •, textì˜ ë‘ë²ˆì§¸ ì¸ìê°’ì€ html ì—¬ë¶€.


```java
@Builder
@Data
public class EmailMessage {

    private String to;
    private String subject;
    private String text;
}
```

- Email dataë¥¼ ë„£ì„ í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ì˜€ê³ , ì´ë¥¼ sendì˜ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•´ì¤€ë‹¤.

```java
Context context = new Context();
context.setVariable("nickName",account.getNickName() );
context.setVariable("link" ,"/check-email-token?token="+ account.getEmailCheckToken()
        + "&email=" + account.getEmail());
context.setVariable("linkName","ì´ë©”ì¼ ì¸ì¦í•˜ê¸°.");
context.setVariable("message","ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•˜ë ¤ë©´ ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì„¸ìš”.");
context.setVariable("host",appProperties.getHost());

String message = templateEngine.process("mail/simple-link", context);

EmailMessage emailMessage = EmailMessage.builder()
        .to(account.getEmail())
        .subject("ìŠ¤í„°ë”” ì›¹ íšŒì› ì¸ì¦")
        .text(message)
        .build();

emailService.send(emailMessage);
```
- í…œí”Œë¦¿ ì—”ì§„ì„ ì‚¬ìš©í•˜ì—¬ html íŒŒì¼ì„ ë§Œë“¤ê³ , TemplateEngine.process("html", context)
- contextëŠ” Viewì— ì „ë‹¬í•˜ëŠ” modelê³¼ ê°™ì€ ì—­í• , ë°ì´í„°ë¥¼ ì „ë‹¬í•´ì¤€ë‹¤. thymeleafì˜ Context

```properties
app.host = http://localhost:8080
```
```java
@Component
@Data
@ConfigurationProperties("app")
public class AppProperties {
    String host;
}

```
- hostëŠ” ì‹¤í–‰ í™˜ê²½ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë”°ë¡œ propertiesê°’ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë„˜ê²¨ì¤€ë‹¤.
- ë¹ˆìœ¼ë¡œ ì£¼ì…ë°›ì•„ ì‚¬ìš©.


# ğŸ“Œ textareaì— ì—ë””í„° ì¶”ê°€í•˜ê¸°
- https://summernote.org/
- ë¶€íŠ¸ìŠ¤íŠ¸ë©ê³¼ ì—°ë™ì´ í¸í•¨.
```npm install summernote```
  > css, js ì¶”ê°€

```javascript
<script type="application/javascript">
    $(function () {
        $("#fullDescription").summernote({
           fontName: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Noto Sans KR', 'Merriweather'],
            placeholder: 'ìŠ¤í„°ë””ì˜ ëª©í‘œ, ì¼ì •, ì§„í–‰ ë°©ì‹, ëª¨ì§‘ ì¤‘ì¸ ìŠ¤í„°ë””ì› ë“± ìƒì„¸í•œ ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”.',
            tabsize:2,
            height: 300
        });
    })
</script>
```
- .summernote í•˜ë©´ ì ìš©,  ì˜µì…˜ ì¶”ê°€ ê°€ëŠ¥.
  
![img_1.png](img_1.png)


# ğŸ“Œ th:classappend
****
```html
<div th:fragment="settingsFragment (currentMenu)">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link" th:href="@{/settings/profile}" th:classappend="${currentMenu =='profile'}? active" role="tab"  >í”„ë¡œí•„</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link text-red" th:href="@{/settings/password}" th:classappend="${currentMenu =='password'}? active" role="tab">íŒ¨ìŠ¤ì›Œë“œ</a>
        </li>
    </ul>
</div>
```

```java
<div th:replace="fragment :: settingsFragment (currentMenu='profile')"/>
```

# ğŸ“Œ ToolTip
****
```html
<span th:if="${!study.published}"
      class="d-inline-block" tabindex="0" data-toggle="tooltip" data-placement="bottom"
      title="ìŠ¤í„°ë”” ê³µê°œ ì¤€ë¹„ì¤‘">
    <button class="btn btn-primary btn-sm" style="pointer-events: none;" type="button" disabled>DRAFT</button>
</span>
```

```javascript
<script type="application/javascript">
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })
</script>
```
- ì—˜ë¦¬ë¨¼íŠ¸.tooltip, title ì†ì„±ì˜ ê°’ì´ íˆ´íŒ ë©”ì‹œì§€ê°€ ëœë‹¤.
![img_3.png](img_3.png)

# ğŸ“Œ EntityGraph
****
- ë‚˜ì¤‘ì— í•„ìš”í•œ ì¿¼ë¦¬ë¥¼ í•œë²ˆì— ë˜ì ¸ ì¿¼ë¦¬ì˜ ìˆ˜ë¥¼ ì¤„ì¸ë‹¤.
- ì‘ì€ ì¿¼ë¦¬ ì—¬ëŸ¬ê°œ -> ë¬´ê±°ìš´ ì»¤ë¦¬ í•œê°œ. ë§ì€ ìˆ˜ì˜ ìš”ì²­ì—ì„œ ìœ ë¦¬í•  ìˆ˜ ìˆë‹¤.

```java
@NamedEntityGraph(name = "Study.withAll", attributeNodes = {
        @NamedAttributeNode("tags"),
        @NamedAttributeNode("zones"),
        @NamedAttributeNode("managers"),
        @NamedAttributeNode("members")
})
```
> Entity í´ë˜ìŠ¤ì— ê·¸ë˜í”„ ì´ë¦„ ì •ì˜.


```java
@EntityGraph(value="Study.withAll", type = EntityGraph.EntityGraphType.LOAD)
Study findByPath(String path);
```
> -  findByPath() ë©”ì„œë“œê°€ í˜¸ì¶œ ë  ë•Œ Study.withAllì— í•´ë‹¹í•˜ëŠ” ë¦´ë ˆì´ì…˜ì„ ëª¨ë‘ ì¡°íšŒí•œë‹¤.
> - EntityGraphType.LOAD : ëª…ì‹œëœ ì—°ê´€ê´€ê³„ëŠ” EAGERë¡œ, ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ ì„¤ì •( *ToOne->EAGER, *ToMany-> Lazy)ì— ë”°ë¦„.

![img_2.png](img_2.png)   
     ...

- ### ì—”í‹°í‹° ê·¸ë˜í”„ ì´ë¦„ì„ ì •ì˜í•˜ì§€ ì•Šê³  ì‚¬ìš©.
```java
@EntityGraph(attributePaths = {"managers", "members"})
Study findStudyWithTeamsByPath(String path);
```

- ### Subgraphs
```java

@NamedEntityGraph(
        name = "Enrollment.withEventAndStudy",
        attributeNodes = {
                @NamedAttributeNode(value = "event", subgraph = "study")
        },
        subgraphs = @NamedSubgraph(name = "study", attributeNodes = @NamedAttributeNode("study"))

)
```
- ì—”í‹°í‹°ê°€ ì°¸ì¡°í•˜ëŠ” ì—”í‹°í‹°ì˜ í•„ë“œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.
- Enrollment.event.study

```java
@EntityGraph(attributePaths = {"event", "event.study"})
Study findStudyWithTeamsByPath(String path);
```
- í•œë²ˆë§Œ ì‚¬ìš©í•  ê²ƒì´ë¼ë©´, ë§ˆì°¬ê°€ì§€ë¡œ ì´ë¦„ì„ ì§€ì •í•˜ì§€ ì•Šê³  ì ìš©í•  ìˆ˜ë„ ìˆë‹¤.
# ğŸ“Œ ì˜ëª»ëœ ì ‘ê·¼ ë°©ì§€
***
```java
public Study getStudyToUpdate(Account account, String path) {
    Study study = getStudy(path);
    if(!study.getManagers().contains(account)){
        throw new AccessDeniedException("í•´ë‹¹ ê¸°ëŠ¥ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
    }

    return study;
}

private Study getStudy(String path) {
    Study study = studyRepository.findByPath(path);
    if(study == null){
        throw new IllegalArgumentException(path +"ì— í•´ë‹¹í•˜ëŠ” ìŠ¤í„°ë””ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }

    return study;
}
```
-urlë¡œ ê¶Œí•œì´ ì—†ëŠ” ì‚¬ìš©ìê°€ ì ‘ê·¼í•˜ê±°ë‚˜, ì˜ëª»ëœ Pathë¡œ ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ì²˜ë¦¬.

# ğŸ“Œ BootStrap:Modal
***
```html
<div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title" id="leaveTitle" th:text="${event.title}"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <p>ëª¨ì„ ì°¸ê°€ ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p><strong>í™•ì¸</strong>í•˜ì‹œë©´ ë³¸ ì°¸ê°€ ì‹ ì²­ì„ ì·¨ì†Œí•˜ê³  ë‹¤ë¥¸ ëŒ€ê¸°ìì—ê²Œ ì°¸ì„ ê¸°íšŒë¥¼ ì¤ë‹ˆë‹¤.</p>
        <p>ê°ì‚¬í•©ë‹ˆë‹¤.</p>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
        <form th:action="@{'/study/' + ${study.path} + '/events/' + ${event.id} + '/disenroll'}" method="post">
            <button class="btn btn-primary" type="submit" aria-describedby="submitHelp">í™•ì¸</button>
        </form>
    </div>
</div>
```
![img_4.png](img_4.png)
# ğŸ“Œ ë‚ ì§œ í˜•ì‹ ë¼ì´ë¸ŒëŸ¬ë¦¬ : Moment.Js
****
```npm install moment --save```
```javascript
<div th:fragment="date-time">
    <script src="/node_modules/moment/min/moment-with-locales.js"></script>
    <script type="application/javascript">
        $(function () {
            moment.locale('ko');
            $(".date-time").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('LLL'); // ì›Œã…“ã„¹, ì¼, ë…„, ì‹œê°„ ,ì˜¤ì „|ì˜¤í›„
            });
            $(".date").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('LL');  // ì›”, ì¼, ë…„
            });
            $(".weekday").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('dddd'); // ìš”ì¼
            });
            $(".time").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('LT'); // ì‹œê°„ ì˜¤ì „|ì˜¤í›„
            });
            $(".calendar").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").calendar(); // ìš” ì‹œê°„ ì˜¤ì „|ì˜¤í›„
            });
            $(".fromNow").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").fromNow();  // ì§€ê¸ˆìœ¼ë¡œ ë¶€í„° ìƒëŒ€ì‹œê°„.
            });
            $(".date-weekday-time").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('LLLL'); // ìš”ì¼, ì›”, ì¼, ë…„ ì‹œê°„ ì˜¤ì „|ì˜¤í›„
            });
        })
    </script>
</div>
```
- ì„œë²„ì˜ í˜•ì‹ì¸ YYYY-MM-DD`T`hh:mm ì„ í¬ë§¤íŒ…í•´ì¤€ë‹¤.
- ìƒëŒ€ ì‹œê°„ ( 25ë¶„ì „ )ë„ ê°€ëŠ¥.
- https://momentjs.com/ ì°¸ì¡°.


# ğŸ“Œ íƒ€ì„ë¦¬í”„ : ê°ì²´ì˜ íƒ€ì… ë³€í™˜
****
```html
<span th:if="${event.eventType == T(com.studyweb.studyweb.event.EventType).FCFS}">ì„ ì°©ìˆœ</span>
<span th:if="${event.eventType == T(com.studyweb.studyweb.event.EventType).CONFIRMATIVE}">ê´€ë¦¬ì í™•ì¸</span>
```
-T(FQCN)

# ğŸ“Œ N+1 ì¿¼ë¦¬ ë¬¸ì œ
****
- ì¿¼ë¦¬ 1ë²ˆìœ¼ë¡œ Nê±´ì„ ê°€ì ¸ì™”ëŠ”ë° ê´€ë ¨ ì»¬ëŸ¼ì„ ì–»ê¸°ìœ„í•´ Në²ˆì˜ ì¶”ê°€ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë¬¸ì œ.
- ì„±ëŠ¥ìƒì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤.

> ex) event ì¡°íšŒì‹œ, enrollmentsë¥¼ eventë‹¹ í•œ ë²ˆì”© ì¡°íšŒí•˜ë¯€ë¡œ Nê°œì˜ ì´ë²¤íŠ¸ë¥¼ ì¡°íšŒí•˜ë©´ Në²ˆì˜ enrollments ì¿¼ë¦¬ê°€ ë°œìƒí•œë‹¤.

```java

// EventëŠ” enrollmentsë¥¼ ê°€ì§.
@OneToMany(mappedBy = "event")
private List<Enrollment> enrollments;
```
-> Eventí•˜ë‚˜ë¥¼ ì¡°íšŒí•  ë•Œë§ˆë‹¤ enrollmentsë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ê°€ ë°œìƒ.

```java
@NamedEntityGraph(name = "Event.withEnrollments", attributeNodes = {
        @NamedAttributeNode("enrollments")
})
```

```java
@EntityGraph(value = "Event.withEnrollments", type= EntityGraph.EntityGraphType.LOAD)
    List<Event> findByStudyOrderByStartDateTime(Study study);
```
- EntityGraphë¥¼ ì´ìš©í•˜ì—¬ Eventë“¤ì´ ì¡°íšŒë  ë•Œ enrollmentsë¥¼ ê°™ì´ ê°€ì ¸ì˜¤ë„ë¡ í•œë‹¤.
- #### [leftjoin](#-í˜ì´ì§•) ìœ¼ë¡œë„ í•´ê²°í•  ìˆ˜ ìˆë‹¤.  

# ğŸ“Œ Form Delete Method
***
```properties
spring.mvc.hiddenmethod.filter.enabled=true
```
-HTML Form ì—ì„œ Put, Delete ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•œìš”ì²­ì„ ë§¤í•‘ ê°€ëŠ¥í•˜ê²Œ í•´ì¤€ë‹¤.


# ğŸ“Œ @PathVariable ê°’ìœ¼ë¡œ Repositoryì—ì„œ ì¡°íšŒ.
****

- ê¸°ì¡´ ì½”ë“œ 
```java 
@PostMapping("/events/{eventId}/enrollments/{enrollId}/accept")
public String acceptUser(@PathVariable Long eventId, @PathVariable Long enrollId){
    Event event = eventService.getEventById(eventId);
    Enrollment enrollment = enrollmentRepository.findById(enrollId).orElseThrow();
    
        eventService.acceptUser(event, enrollment);


    return "redirect:/study/"+study.getPath(path) + "/events/"+eventId;
}
```

- ê°œì„  í›„
```java
@PostMapping("/events/{eventId}/enrollments/{enrollId}/accept")
public String acceptUser(@PathVariable("eventId") Event event, @PathVariable("enrollId") Enrollment enrollment){

    eventService.acceptUser(event, enrollment);

    return "redirect:/study/"+study.getPath(path) + "/events/"+event.getId();
}
```


# ğŸ“Œ íŒ¨í‚¤ì§€ êµ¬ì¡° ì •ë¦¬
****

### - ì•„í‚¤í…ì³ í…ŒìŠ¤íŠ¸ ìœ í‹¸ë¦¬
```xml
<dependency>
    <groupId>com.tngtech.archunit</groupId>
    <artifactId>archunit-junit5</artifactId>
    <version>0.13.1</version>
    <scope>test</scope>
</dependency>
```

```java
package com.studyweb.studyweb;

import com.studyweb.studyweb.modules.account.Account;
import com.tngtech.archunit.junit.AnalyzeClasses;
import com.tngtech.archunit.junit.ArchTest;
import com.tngtech.archunit.lang.ArchRule;

import static com.tngtech.archunit.lang.syntax.ArchRuleDefinition.classes;
import static com.tngtech.archunit.library.dependencies.SlicesRuleDefinition.slices;

@AnalyzeClasses(packagesOf = StudywebApplication.class)
public class PackageDependencyTests {

    private static final String STUDY = "..modules.study..";
    private static final String EVENT = "..modules.event..";
    private static final String ACCOUNT = "..modules.account..";
    private static final String TAG = "..modules.zone..";
    private static final String ZONE = "..modules.tag..";

    // Modules íŒ¨í‚¤ì§€ëŠ” Modules íŒ¨í‚¤ì§€ì—ì„œë§Œ ì°¸ì¡°.
    @ArchTest
    ArchRule modulesRule = classes().that().resideInAnyPackage("com.studyweb.studyweb.modules..")
            .should().onlyBeAccessed().byClassesThat()
            .resideInAnyPackage("com.studyweb.studyweb.modules..");
    
    // Study íŒ¨í‚¤ì§€ëŠ” Study, Event íŒ¨í‚¤ì§€ì—ì„œë§Œ ì°¸ì¡°.
    @ArchTest
    ArchRule studyPackageRule = classes().that().resideInAPackage(STUDY)
            .should().onlyBeAccessed().byClassesThat()
            .resideInAnyPackage(STUDY,EVENT);

    // Account íŒ¨í‚¤ì§€ëŠ” Account,Tag,Zone íŒ¨í‚¤ì§€ë¥¼ ì°¸ì¡°
    @ArchTest
    ArchRule accountPackageRule = classes().that().resideInAPackage(ACCOUNT)
            .should().accessClassesThat()
            .resideInAnyPackage(ACCOUNT, TAG, ZONE);

    //Event íŒ¨í‚¤ì§€ëŠ” Account,Study, Event íŒ¨í‚¤ì§€ë¥¼ ì°¸ì¡°.
    @ArchTest
    ArchRule eventPackageRule = classes().that().resideInAPackage(EVENT)
            .should().accessClassesThat()
            .resideInAnyPackage(ACCOUNT, STUDY, EVENT);

    // ìˆœí™˜ì°¸ì¡°ê°€ ì—†ì–´ì•¼ í•¨.
    @ArchTest
    ArchRule cycleCheck = slices().matching("com.studyweb.studyweb.modules.(*)..")
            .should().beFreeOfCycles();
}
```
- í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ìœ„ë°˜ë˜ëŠ” ê³³ì„ ë¡œê·¸ë¡œ ì¶œë ¥í•´ ì¤€ë‹¤. ì˜ëª»ëœ ì°¸ì¡°ë¥¼ í•˜ê³  ìˆëŠ” ë¶€ë¶„ì„ ìˆ˜ì •.

# ğŸ“Œ test DB ì„¤ì • : TestContainers
*****
- í…ŒìŠ¤íŠ¸ìš© DBë¥¼ ë”°ë¡œ ìš´ì˜í•˜ëŠ” ê²ƒì€ ë²ˆê±°ë¡­ë‹¤.
> TestContainersë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬ì„±.
```xml
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>junit-jupiter</artifactId>
    <version>1.13.0</version>
    <scope>test</scope>
</dependency>

<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>postgresql</artifactId>
    <version>1.13.0</version>
    <scope>test</scope>
</dependency>
```


# ğŸ“Œ ë¹„ë™ê¸° EventListener
****
```java
private final ApplicationEventPublisher applicationEventPublisher;

applicationEventPublisher.publishEvent(new StudyCreatedEvent(study));
```
- ì´ë²¤íŠ¸ë¥¼ applicationEventPublisherì— ë“±ë¡.

```java
@Getter
public class StudyCreatedEvent {
    private Study study;
    public StudyCreatedEvent(Study study) {
        this.study = study;
    }
}
```

```java
@Async
@Slf4j
@Transactional(readOnly = true)
@Component
public class StudyEventHandler {

    @EventListener
    public void handleStudyCreatedEvent(StudyCreatedEvent studyCreatedEvent){
        log.info(studyCreatedEvent.getStudy().getTitle() + " is created.");
        //TODO ì´ë©”ì¼, ì•Œë¦¼ ì²˜ë¦¬
    }
}
```
- EventListenerì—ì„œ ì²˜ë¦¬ Event ê°ì²´ë¥¼ ë°›ì•„ ì²˜ë¦¬.
- ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ @Async ì‚¬ìš©.
- ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ mainì€ ê·¸ëŒ€ë¡œ ì‹¤í–‰ ë¨.
- ì„±ëŠ¥ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ í•˜ê¸° ìœ„í•´.

```java
@Configuration
@EnableAsync
public class AsyncConfig implements AsyncConfigurer {

    @Override
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        int corePoolSize = Runtime.getRuntime().availableProcessors();
        executor.setCorePoolSize(corePoolSize);
        executor.setMaxPoolSize(corePoolSize * 2);
        executor.setQueueCapacity(50);
        executor.setKeepAliveSeconds(60);
        executor.setThreadNamePrefix("AsyncExcutor-");
        executor.initialize();



        return executor;
    }
}
```
- AsyncConfigurerì˜ Executorë¥¼ êµ¬í˜„í•˜ì—¬ í’€ ì‚¬ì´ì¦ˆ, í ì‚¬ì´ì¦ˆ ì„¸íŒ…

> - setCorePoolSize() -- ì‚¬ìš©í•  ì½”ì–´ ì‚¬ì´ì¦ˆ ì„¤ì •.    
> - setQueueCapacity() : ì½”ì–´ ì‚¬ì´ì¦ˆ ë§Œí¼ ì“°ë ˆë“œê°€ ìƒì„± ë˜ì—ˆì„ ë•Œ ëŒ€ê¸°ì—´ì˜ í¬ê¸°. ê¸°ë³¸ê°’ì€ int max
> - setMaxPoolSize() : ëŒ€ê¸°ì—´ì´ ëª¨ë‘ ê°€ë“ ì°¼ì„ ë•Œ ì¶”ê°€ë¡œ ìƒì„±ë  ìˆ˜ ìˆëŠ” ì“°ë ˆë“œì˜ ë§¥ìŠ¤ ì½”ì–´ ì‚¬ì´ì¦ˆ.
> - setKeepAliveSeconds() : ì½”ì–´ ì‚¬ì´ì¦ˆë¥¼ ë„˜ì–´ ìƒì„±ëœ ì“°ë ˆë“œë¥¼ íšŒìˆ˜í•˜ëŠ” ì‹œê°„.
> - setThreadNamePrefix() : ì“°ë ˆë“œ ì´ë¦„.

# ğŸ“Œ QeuryDSL
***
- íƒ€ì… ì„¸ì´í”„ í•˜ê²Œ JPA ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.


```xml
<dependency>
    <groupId>com.querydsl</groupId>
    <artifactId>querydsl-jpa</artifactId>
</dependency>
```
```xml
<plugin>
    <groupId>com.mysema.maven</groupId>
    <artifactId>apt-maven-plugin</artifactId>
    <version>1.1.3</version>
    <executions>
        <execution>
            <goals>
                <goal>process</goal>
            </goals>
            <configuration>
                <outputDirectory>target/generated-sources/java</outputDirectory>
                <processor>com.querydsl.apt.jpa.JPAAnnotationProcessor</processor>
            </configuration>
        </execution>
    </executions>
    <dependencies>
        <dependency>
            <groupId>com.querydsl</groupId>
            <artifactId>querydsl-apt</artifactId>
            <version>4.2.2</version>
        </dependency>
    </dependencies>
</plugin>
```
> - QEntityë¥¼ ë§Œë“¤ì–´ì¤˜ì•¼ í•˜ì§€ë§Œ í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ë©´ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì¤€ë‹¤.
> - í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€ í›„ Compile


##  1. QuerydslPredicateExecutor<T> ìƒì†
```java
extends QuerydslPredicateExecutor<Account>
```
- QuerydslPredicateExecutorë¥¼ ìƒì† ë°›ì•„ í•´ë‹¹ ë©”ì†Œë“œë“¤ì„ ì‚¬ìš© í•œë‹¤.
```java
public interface QuerydslPredicateExecutor<T> {
    Optional<T> findOne(Predicate var1);
    Iterable<T> findAll(Predicate var1);
    Iterable<T> findAll(Predicate var1, Sort var2);
    Iterable<T> findAll(Predicate var1, OrderSpecifier<?>... var2);
    Iterable<T> findAll(OrderSpecifier<?>... var1);
    Page<T> findAll(Predicate var1, Pageable var2);
    long count(Predicate var1);
    boolean exists(Predicate var1);
}
```

###  Predicate ìƒì„±.
```java
public class AccountPredicate {

    public static Predicate findByTagsAndZones(Set<Tag> tags, Set<Zone> zones){
        QAccount account = QAccount.account;
        return account.tags.any().in(tags).and(account.zones.any().in(zones));
    }
}
```
- Java ì½”ë“œë¡œ íƒ€ì… ì„¸ì´í”„í•œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.
- any() : í•œê°œ ì´ìƒ.
- in() : í¬í•¨.


3. ì‚¬ìš© ì˜ˆì‹œ
```java
//detached ìƒíƒœì—ì„œëŠ” tagsì™€ zonesë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— persist ìƒíƒœë¡œ ë§Œë“¤ì–´ì£¼ê¸° ìœ„í•´ ë‹¤ì‹œ ì¡°íšŒ
Study study =  studyRepository.findStudyWithTagsAndZonesByPath(studyCreatedEvent.getStudy().getPath());

//Iterable<T> findAll(Predicate var1)
Iterable<Account> accounts = accountRepository.findAll(AccountPredicate.findByTagsAndZones(study.getTags(), study.getZones()));

accounts.forEach(a ->{
    if(a.isStudyCreatedByEmail()){
        sendStudyCreatedNotificationEmail(study, a);
    }
    if(a.isStudyCreatedByWeb()){
        saveCreatedStudyNotification(study, a);
    }
});
```

## 2. extends QuerydslRepositorySupport
```java
@Transactional(readOnly = true)
public interface StudyRepositoryExtension {
    List<Study> findByKeyword(String keyword);
}

```
- Repositoryì˜ í™•ì¥ ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê³ , ë©”ì†Œë“œë¥¼ ì •ì˜í•œë‹¤.
- ì›ë˜ì˜ Repositoryì—ì„œ ì´ë¥¼ ìƒì†í•œë‹¤.

### RepositoryExtensionImpl
```java
public class StudyRepositoryExtensionImpl extends QuerydslRepositorySupport implements StudyRepositoryExtension{
    
    public StudyRepositoryExtensionImpl() {
        super(Study.class);
    }

    @Override
    public List<Study> findByKeyword(String keyword) {
        QStudy study = QStudy.study;
        JPQLQuery<Study> findStudyByKeywordQuery = from(study).where(study.published.isTrue()
                .and(study.title.containsIgnoreCase(keyword))
                .or(study.zones.any().localNameOfCity.containsIgnoreCase(keyword))
                .or(study.tags.any().title.containsIgnoreCase(keyword)))
                .leftJoin(study.tags, QTag.tag).fetchJoin()
                .leftJoin(study.zones, QZone.zone).fetchJoin()
                .leftJoin(study.members, QAccount.account).fetchJoin()
                .distinct();

        return findStudyByKeywordQuery.fetch();

    }
}
```
- í´ë˜ìŠ¤ëª…ì€ {extensionInterface}Impl í˜•ì‹.
- Qeuryë¥¼ ìƒì„±í•˜ê³  fetchë¥¼ ë°˜í™˜.
- ì½”ë“œì˜ ì˜ˆì‹œëŠ” keywordë¥¼ í†µí•œ ìŠ¤í„°ë”” íƒ€ì´í‹€, íƒœê·¸, ì§€ì—­ì—ì„œì˜ ê²€ìƒ‰ì´ë‹¤.
- N+1 Select ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ left ì¡°ì¸ì„ í•˜ê³ , fetchë¥¼ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ fetchJoinì„ í–ˆë‹¤.

# ğŸ“Œ Handler Interceptor
****
- Eventì˜ ì²˜ë¦¬ ì „(pre), ì²˜ë¦¬ í›„(post), viewë¥¼ ë¶ˆëŸ¬ì˜¨ í›„(afterCompletion) ìˆ˜í–‰í•  ì¼ ì§€ì •.

```java
@RequiredArgsConstructor
@Component
public class NotificationHandlerInterceptor implements HandlerInterceptor {

    private final NotificationRepository notificationRepository;

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();


        if(modelAndView !=null && !isRedirectview(modelAndView) && authentication.getPrincipal() != null && authentication.getPrincipal() instanceof UserAccount){
            Account account = ((UserAccount) authentication.getPrincipal()).getAccount();
            Long count = notificationRepository.countNotificationByAccountAndChecked(account, false);

            modelAndView.addObject("hasNotification", count>0);
            modelAndView.addObject("numberOfNotification", count);


        }

    }
```
- HandlerInterceptor ì˜ ë©”ì†Œë“œë¥¼ êµ¬í˜„í•˜ì—¬ ì‘ë™í•œë‹¤.
- Request, Response, Handler, Model, Viewë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆë‹¤.

# ğŸ“Œ í˜ì´ì§•
****
```java
 @Override
public Page<Study> findByKeyword(String keyword, Pageable pageable) {
    QStudy study = QStudy.study;
    JPQLQuery<Study> findStudyByKeywordQuery = from(study).where(study.published.isTrue()
            .and(study.title.containsIgnoreCase(keyword))
            .or(study.zones.any().localNameOfCity.containsIgnoreCase(keyword))
            .or(study.tags.any().title.containsIgnoreCase(keyword)))
            .leftJoin(study.tags, QTag.tag).fetchJoin()
            .leftJoin(study.zones, QZone.zone).fetchJoin()
            .leftJoin(study.members, QAccount.account).fetchJoin()
            .distinct();

    JPQLQuery<Study> pageableQuery = getQuerydsl().applyPagination(pageable, findStudyByKeywordQuery);
    QueryResults<Study> fetchResults = pageableQuery.fetchResults();

    // ê²°ê³¼ , pageable, ê²°ê³¼ ìˆ˜(ì—¬ê¸°ì„œëŠ” Studyì˜ ìˆ˜)
    return new PageImpl<>(fetchResults.getResults(), pageable, fetchResults.getTotal());
    
```

```java
@GetMapping("/search/study") //pageable : size, page start Index, sort ê¸°ì¤€
    public String studySearch(@PageableDefault(size = 9, page = 0, sort ="memberCount", direction = Sort.Direction.DESC) Pageable pageable, String keyword, Model model){

        Page<Study> studyList = studyRepository.findByKeyword(keyword, pageable);

        model.addAttribute("keyword", keyword);
        model.addAttribute("studyPage", studyList);
        model.addAttribute("sortProperty", pageable.getSort().toString()); // memberCount: DESC
        model.addAttribute("order", pageable.getSort().toString().split(": ")[1]); // DESC 

        return "search-view";
    }
```
- default sizeëŠ” 20, classì˜ propertyë¥¼ sort ê¸°ì¤€ìœ¼ë¡œ ì •í•¨.

- ### ë¶€íŠ¸ ìŠ¤íŠ¸ë©ì˜ pagination
```html
<div class="row justify-content-center">
    <div class="col-sm-10">
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${!studyPage.hasPrevious()}? disabled">
                    <a th:href="@{'/search/study?keyword=' + ${keyword} + '&sort=' + ${sortProperty.split(':')[0]} + ','+${order}+'&page=' + ${studyPage.getNumber() - 1}}"
                       class="page-link" tabindex="-1" aria-disabled="true">
                        Previous
                    </a>
                </li>
                <li class="page-item" th:classappend="${i == studyPage.getNumber()}? active"
                    th:each="i: ${#numbers.sequence(0, studyPage.getTotalPages() - 1)}">
                    <a th:href="@{'/search/study?keyword=' + ${keyword} + '&sort=' + ${sortProperty.split(':')[0]} + ','+${order}+'&page=' + ${i}}"
                       class="page-link" href="#" th:text="${i + 1}">1</a>
                </li>
                <li class="page-item" th:classappend="${!studyPage.hasNext()}? disabled">
                    <a th:href="@{'/search/study?keyword=' + ${keyword} + '&sort=' + ${sortProperty.split(':')[0]} + ','+${order}+'&page=' + ${studyPage.getNumber() + 1}}"
                       class="page-link">
                        Next
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>
```

```html
<a class="dropdown-item" th:classappend="${#strings.contains(sortProperty, 'memberCount')}? active"
   th:href="@{'/search/study?sort=memberCount,DESC&keyword=' + ${keyword}+'&page='+ ${studyPage.getNumber()}}">
    ë©¤ë²„ìˆ˜
</a>
```
- sortProperty(pageable.getSort) ì˜ í˜•ì‹ì€ property: Order
- sort ì˜ value ë¡œ sort property ì™€ order ë¥¼ ë„˜ê²¨ì¤„ ìˆ˜ ìˆê³ , pageì˜ ê°’ìœ¼ë¡œ page number ë¥¼ ë„˜ê²¨ì¤„ ìˆ˜ ìˆë‹¤.     
- Page.getNumber()  or  Page.pageable.getNumber() => í˜„ì¬ í˜ì´ì§€
  

# ğŸ“Œ Mark.js
***
- íŠ¹ì • í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŒ…
```npm install mark.js --save```
  
```javascript
<script src="/node_modules/mark.js/dist/jquery.mark.js"></script>
<script type="application/javascript">
    $(function(){
        var mark = function() {
            // Read the keyword
            var keyword = $("#keyword").text();

            // Determine selected options
            var options = {
                "each": function(element) {
                    setTimeout(function() {
                        $(element).addClass("animate");
                    }, 150);
                }
            };

            // Mark the keyword inside the context
            $(".context").unmark({
                done: function() {
                    $(".context").mark(keyword, options);
                }
            });
        };

        mark();
    });
</script>
```
- ìƒ‰ê³¼ ê°™ì€ style ê°’ì€ cssì—ì„œ ë³€ê²½ ê°€ëŠ¥í•˜ë‹¤.
```css
 mark {
    color:red;
    transition: all .5s;
}

mark.animate {
    color: #000;
    background-color:skyblue;

}
```


# ğŸ“Œ Exception Handler
****
- ../template/error/ 404.html or 5xx.html ê³¼ ê°™ì´ ì—ëŸ¬í˜ì´ì§€ ì„¤ì • ê°€ëŠ¥.
- ../template/error.htmlë¡œ ì„¤ì • ê°€ëŠ¥.

- ### Handler
```java
@Slf4j
@ControllerAdvice
public class ExceptionAdvice {

    @ExceptionHandler
    public String handleRuntimeException(@CurrentUser Account account, HttpServletRequest req, RuntimeException e){
        if(account != null){
            log.info("{} Requested {}", account.getNickName(), req.getRequestURI());
        }
        else{
            log.info("Requested {}",  req.getRequestURI());
        }
        log.error("Bad Request : ", e);

        return "error";

    }
}
```
- ìš”ì²­ì„ ë³´ë‚¸ ì‚¬ëŒê³¼ ìš”ì²­ì˜ URI ë¥¼ ë¡œê¹….
- error ë ˆë²¨ë¡œ Exception ë¡œê¹….


# ğŸ“Œ ë°°í¬ì‹œ ê³ ë ¤í•  ì 
***
- ì„¤ì • íŒŒì¼
> - ìš°ì„ ìˆœìœ„ë¥¼ ê³ ë ¤
> - ë¯¼ê°í•œ ì •ë³´ê°€ ìœ ì¶œë˜ì§€ ì•Šë„ë¡ ê³ ë ¤.

- ë¡œê¹…
> - ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œê³¼ì˜ ì—°ë™
> - ë¯¼ê°í•œ ë°ì´í„° ë¡œê¹…í•˜ì§€ ì•Šë„ë¡.
> - ë°°í¬ í™˜ê²½ì— ì•Œë§ì€ ë¡œê¹… ì„¤ì •.

- íŒ¨í‚¤ì§•
> - ì™¸ì¥ í†°ìº£ì— WARë¡œ?
> - í†°ìº£ì„ ë‚´ì¥í•˜ì—¬ JARë¡œ?

- ë°°í¬ ë°©ë²•
> - CI / CD êµ¬ì¶•

